.. _ja_fault:

障害対応
==================

.. TODO descrption

.. contents::
   :backlinks: none
   :local:

DSの復旧
----------------------

DS (Data Server) が故障すると、その状態が "FAULT" になります：

::

    $ ls4ctl node01 nodes
    nid            name                 address                location    rsid      state
      0          node03       192.168.0.13:18900      subnet-192.168.000       0     active
      1          node04       192.168.0.14:18900      subnet-192.168.000       0     FAULT
      2          node05       192.168.0.15:18900      subnet-192.168.000       1     active
      3          node06       192.168.0.16:18900      subnet-192.168.000       1     active

DSを復旧する手順は、データが失われた（HDDが故障した）か失われていない（プロセスがダウンした）かによって異なります。

データが失われていない場合
^^^^^^^^^^^^^^^^^^^^^^

**--nid** 引数と **--rsid** を変更せずに、サーバのプロセスを再起動してください。

故障したサーバと新しいサーバでは、異なるIPアドレスを使うことができます。ただし、その場合でもすべてのデータ（リレータイムスタンプファイル *rts-*\* と更新ログファイル *ulog-*\* を含む）を引き継いでください。

データが失われた場合
^^^^^^^^^^^^^^^^^^^^^^

もしデータが失われた場合は、そのサーバを取り除く必要があります。

::

    $ ls4ctl node01 remove_node 1

この後で新しいノードを追加してください。

関連: :ref:`ja_operation`


CSの復旧
----------------------

CSのIPアドレスは変更することができないので、新しいサーバには故障したサーバと同じIPアドレスを振る必要があります。あるいはCSに専用のIPエイリアスを割り当てているなら、そのIPエイリアスを新しいサーバに振ってください。

CSを復旧する手順は、データが失われたか失われていないかによって異なります。

データが失われていない場合
^^^^^^^^^^^^^^^^^^^^^^

ls4-csプロセスを再起動してください。

データが失われた場合
^^^^^^^^^^^^^^^^^^^^^^

CSはクラスタの情報（ *membership* ファイルと *fault* ファイル）を保存しています。実はこれらの情報は、他のノードにもキャッシュされています。
このため、まずそのキャッシュされた情報をDSやGWからコピーしてきてください：

::

    [on node01]$ mkdir /var/ls4/cs
    [on node01]$ scp node03:/var/ls4/node03/membership node03:/var/ls4/node03/fault /var/ls4/cs/

コピーが終わったら、ls4-csプロセスを再起動してください。


GWの復旧
----------------------

GW (Gateway) は *ステートレス* なプロセスなので、単にプロセスを再起動してください。


次のステップ： :ref:`ja_plugin`

