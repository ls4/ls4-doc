.. _ja_fault:

障害対応
==================

LS4は耐障害性を備えた分散ストレージシステムです。ここでは障害からアプリケーションに影響を及ぼさずにシステムを復旧する方法について述べます。

.. contents::
   :backlinks: none
   :local:

DSの復旧
----------------------

DS (Data Server) が故障すると、その状態が "FAULT" になります：

::

    $ ls4ctl node01 nodes
    nid            name                 address                location    rsid      state
      0          node03       192.168.0.13:18900      subnet-192.168.000       0     active
      1          node04       192.168.0.14:18900      subnet-192.168.000       0     FAULT
      2          node05       192.168.0.15:18900      subnet-192.168.000       1     active
      3          node06       192.168.0.16:18900      subnet-192.168.000       1     active

DSを復旧する手順は、データが失われた（HDDが故障した）か、失われていない（プロセスがダウンした）かによって異なります。

データが失われていない場合
^^^^^^^^^^^^^^^^^^^^^^

**--nid** 引数と **--rsid** 引数を変更せずに、サーバのプロセスを再起動してください。プロセスを再起動すると、プロセスがダウンしていた間に行われた更新操作の同期が自動的に始まります。

故障したサーバと新しいサーバでは、異なるIPアドレスを使うことができます。ただし、その場合でもすべてのデータ（リレータイムスタンプファイル *rts-*\* と更新ログファイル *ulog-*\* を含む）を引き継いでください。

データが失われた場合
^^^^^^^^^^^^^^^^^^^^^^

データが失われた場合は、いったんそのサーバを取り除き、新たなサーバを追加します。

サーバを取り除くには、 *ls4ctl remove_node* コマンドを使用します：

::

    $ ls4ctl node01 remove_node 1

新しいサーバを追加する方法は、 :ref:`ja_operation_add_server` を参照してください。

関連： :ref:`ja_command_ctl`


CSの復旧
----------------------

CSのIPアドレスは変更することができないので、新しいサーバには故障したサーバと同じIPアドレスを振る必要がある点に注意してください（関連： :ref:`ja_build_ipalias` ）。

CSを復旧する手順は、クラスタの状態ファイル（障害状況ファイル、メンバシップファイル、重み情報ファイル）が失われたか失われていないかによって異なります。

関連： ref:`ja_command_cs`

データが失われていない場合
^^^^^^^^^^^^^^^^^^^^^^

ls4-csプロセスを再起動してください。

データが失われた場合
^^^^^^^^^^^^^^^^^^^^^^

CSが管理している情報は、他のノードにもキャッシュされています。
このため、それらのファイルをDSやGWからコピーすることで、CSの状態を復元できます：

::

    [on node01]$ mkdir /var/ls4/cs
    [on node01]$ scp node03:/var/ls4/node03/membership node03:/var/ls4/node03/fault /var/ls4/cs/

コピーが終わったら、ls4-csプロセスを再起動してください。


GWの復旧
----------------------

GW (Gateway) は *ステートレス* なプロセスなので、単にプロセスを再起動するだけで復旧することができます。


次のステップ： :ref:`ja_plugin`

